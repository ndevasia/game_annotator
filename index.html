<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Video + Annotations</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: linear-gradient(180deg, #0d0221, #1a1a40, #2e0249);
      color: #eee;
      min-height: 100vh;
    }

    /* Section headers under the main neon heading */
    h2, h3 {
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.4em;
      font-weight: normal;
      color: #00ffff;
      text-shadow: 0 0 5px #00ffff, 0 0 10px #0088ff;
      margin-bottom: 10px;
    }

    .session {
      margin-bottom: 40px;
    }

    video {
      width: 100%;
      max-width: 700px;
      margin-bottom: 1em;
      border: 2px solid #00ffff;
      border-radius: 6px;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
    }

    .annotations {
      margin-top: 10px;
      max-width: 700px;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(255, 0, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(255,0,255,0.2);
    }

    .annotation {
      padding: 6px 12px;
      margin-bottom: 6px;
      border-left: 4px solid #ff00ff;
      background: linear-gradient(90deg, rgba(255,0,255,0.08), rgba(0,255,255,0.08));
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      line-height: 1.4;
      justify-content: space-between; /* text on left, button on far right */
    }

    .annotation:hover {
      background: linear-gradient(90deg, rgba(255,0,255,0.15), rgba(0,255,255,0.15));
      transform: scale(1.02);
    }

    .annotation .emoji {
      margin-right: 8px;
      font-size: 1.2em;
    }

    .annotation .time {
      font-weight: bold;
      margin-right: 6px;
      color: #00ffff;
    }

    .annotation .text {
      color: #ddd;
    }

    .annotation-content {
      flex: 1; /* takes all available space */
    }

    /* Neon spinner */
    .loader {
      border: 6px solid rgba(0, 255, 255, 0.1);
      border-top: 6px solid #00ffff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;

      margin: 40px auto;
      display: none; /* hidden by default */
      box-shadow: 0 0 12px #00ffff, 0 0 24px #00ffff;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }


    .annotation button {
      display: none;              /* hidden by default */
      margin-left: 12px;
      background: transparent;
      border: none;
      color: #ff5555;
      font-size: 1.1em;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s, color 0.2s;
      opacity: 0;
    }

    .annotation:hover button {
      display: inline;
      opacity: 1;                 /* smooth fade in */
    }
    /* Neon Heading (same as before) */
    .neon-heading {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5em;
      font-weight: bold;
      text-transform: uppercase;
      text-align: center;

      background: linear-gradient(90deg, #ff00ff, #00ffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;

      /* controlled glow */
      text-shadow: 
        0 0 5px rgba(255,0,255,0.7),
        0 0 12px rgba(0,255,255,0.5);

      -webkit-text-stroke: 1px rgba(0,0,0,0.6); /* crisp outline */
      animation: neonPulse 1.8s ease-in-out infinite alternate;
    }

    @keyframes neonPulse {
      from {
        text-shadow:
          0 0 5px #ff00ff,
          0 0 10px #ff00ff,
          0 0 20px #00ffff,
          0 0 30px #00ffff,
          0 0 40px #ff00ff;
      }
      to {
        text-shadow:
          0 0 10px #ff00ff,
          0 0 20px #ff00ff,
          0 0 30px #00ffff,
          0 0 40px #00ffff,
          0 0 50px #ff00ff;
      }
    }


  </style>
</head>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Video + Annotations</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: linear-gradient(180deg, #0d0221, #1a1a40, #2e0249);
      color: #eee;
    }

    /* Section headers under the main neon heading */
    h2, h3 {
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.4em;
      font-weight: normal;
      color: #00ffff;
      text-shadow: 0 0 5px #00ffff, 0 0 10px #0088ff;
      margin-bottom: 10px;
    }

    .session {
      margin-bottom: 40px;
    }

    video {
      width: 100%;
      max-width: 700px;
      margin-bottom: 1em;
      border: 2px solid #00ffff;
      border-radius: 6px;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
    }

    .annotations {
      margin-top: 10px;
      max-width: 700px;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(255, 0, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(255,0,255,0.2);
    }

    .annotation {
      padding: 6px 12px;
      margin-bottom: 6px;
      border-left: 4px solid #ff00ff;
      background: linear-gradient(90deg, rgba(255,0,255,0.08), rgba(0,255,255,0.08));
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      line-height: 1.4;
      justify-content: space-between; /* text on left, button on far right */
    }

    .annotation:hover {
      background: linear-gradient(90deg, rgba(255,0,255,0.15), rgba(0,255,255,0.15));
      transform: scale(1.02);
    }

    .annotation .emoji {
      margin-right: 8px;
      font-size: 1.2em;
    }

    .annotation .time {
      font-weight: bold;
      margin-right: 6px;
      color: #00ffff;
    }

    .annotation .text {
      color: #ddd;
    }

    .annotation-content {
      flex: 1; /* takes all available space */
    }

    .annotation button {
      display: none;              /* hidden by default */
      margin-left: 12px;
      background: transparent;
      border: none;
      color: #ff5555;
      font-size: 1.1em;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s, color 0.2s;
      opacity: 0;
    }

    .annotation:hover button {
      display: inline;
      opacity: 1;                 /* smooth fade in */
    }
    /* Neon Heading (same as before) */
    .neon-heading {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5em;
      font-weight: bold;
      text-transform: uppercase;
      text-align: center;

      background: linear-gradient(90deg, #ff00ff, #00ffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;

      /* controlled glow */
      text-shadow: 
        0 0 5px rgba(255,0,255,0.7),
        0 0 12px rgba(0,255,255,0.5);

      -webkit-text-stroke: 1px rgba(0,0,0,0.6); /* crisp outline */
      animation: neonPulse 1.8s ease-in-out infinite alternate;
    }

    @keyframes neonPulse {
      from {
        text-shadow:
          0 0 5px #ff00ff,
          0 0 10px #ff00ff,
          0 0 20px #00ffff,
          0 0 30px #00ffff,
          0 0 40px #ff00ff;
      }
      to {
        text-shadow:
          0 0 10px #ff00ff,
          0 0 20px #ff00ff,
          0 0 30px #00ffff,
          0 0 40px #00ffff,
          0 0 50px #ff00ff;
      }
    }


  </style>
</head>
  <body>
  <h1 class="neon-heading">Annotated Sessions</h1>
  <div id="loader" class="loader"></div>
  <div id="sessions"></div>
  <button id="load-more" style="display:none; margin: 20px auto; padding: 10px 20px;
    background: #00ffff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
    Load More Sessions
  </button>

  <!-- Back to Home Screen button -->
  <button id="back-home" style="
    margin: 20px auto;
    display: block;
    padding: 10px 20px;
    border: 1px solid #ff00ff;
    border-radius: 6px;
    background: rgba(40,0,60,0.6);
    color: #ff00ff;
    font-family: 'Share Tech Mono', monospace;
    cursor: pointer;
    text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff;
    transition: all 0.2s ease-in-out;
  ">
    Back to Home Screen
  </button>

  <script>
    const fs = require('fs');
    const path = require('path');
    const { ipcRenderer } = require('electron');
    const AWSManager = require('./backend/aws.js');

    const sessionContainer = document.getElementById('sessions');
    const loadMoreBtn = document.getElementById('load-more');

    let client;
    let allSessions = [];
    let visibleCount = 0;
    const PAGE_SIZE = 5;

    ipcRenderer.on('session-data', async (event, username) => {
      const loader = document.getElementById("loader");
      loader.style.display = "block";   // ⬅ show loading animation

      sessionContainer.innerHTML = "";  // clear
      loadMoreBtn.style.display = "none";

      if (!username) {
        loader.style.display = "none";
        sessionContainer.innerHTML = '<p>No username found in session data.</p>';
        return;
      }

      client = new AWSManager(username);
      await client.init();

      try {
        allSessions = await client.loadSessionsFromS3(username);

        loader.style.display = "none";   // ⬅ hide loader when done

        if (allSessions.length === 0) {
          sessionContainer.innerHTML = '<p>No sessions found in S3.</p>';
          return;
        }

        visibleCount = 0;
        renderNextPage();

      } catch (err) {
        console.error('Error loading sessions from S3:', err);
        loader.style.display = "none";
        sessionContainer.innerHTML = '<p>Error loading sessions.</p>';
      }
    });


    function renderNextPage() {
      const next = allSessions.slice(visibleCount, visibleCount + PAGE_SIZE);
      next.forEach(createSession);
      visibleCount += next.length;

      // toggle button visibility
      if (visibleCount < allSessions.length) {
        loadMoreBtn.style.display = 'block';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    loadMoreBtn.addEventListener('click', renderNextPage);

    function createSession(session) {
      const sessionDiv = document.createElement('div');
      sessionDiv.className = 'session';

      const heading = document.createElement('h2');
      const date = new Date(session.videoStartTimestamp);
      const options = {
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: true, month: 'numeric', day: 'numeric', year: '2-digit'
      };
      heading.textContent = `${session.title} – ${date.toLocaleTimeString(undefined, options)}`;
      // Highlight sessions that use a local video fallback for easier discovery
      if (session.videoUrl && session.videoUrl.startsWith('file://')) {
        heading.style.color = '#FFD166';
      }
      // Delete Session button
      const deleteSessionBtn = document.createElement('button');
      deleteSessionBtn.textContent = "Delete Session";

      // neon/cyberpunk styling
      deleteSessionBtn.style.marginLeft = "15px";
      deleteSessionBtn.style.padding = "6px 14px";
      deleteSessionBtn.style.border = "1px solid #ff00ff";
      deleteSessionBtn.style.borderRadius = "6px";
      deleteSessionBtn.style.background = "rgba(40,0,60,0.6)";
      deleteSessionBtn.style.color = "#ff00ff";
      deleteSessionBtn.style.fontFamily = "'Share Tech Mono', monospace";
      deleteSessionBtn.style.cursor = "pointer";
      deleteSessionBtn.style.textShadow = "0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff";
      deleteSessionBtn.style.transition = "all 0.2s ease-in-out";

      // hover effect
      deleteSessionBtn.onmouseenter = () => {
        deleteSessionBtn.style.background = "rgba(255,0,255,0.2)";
        deleteSessionBtn.style.color = "#00ffff";
        deleteSessionBtn.style.textShadow = "0 0 8px #00ffff, 0 0 16px #00ffff";
      };
      deleteSessionBtn.onmouseleave = () => {
        deleteSessionBtn.style.background = "rgba(40,0,60,0.6)";
        deleteSessionBtn.style.color = "#ff00ff";
        deleteSessionBtn.style.textShadow = "0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff";
      };

      deleteSessionBtn.onclick = async () => {
        if (!confirm("Are you sure you want to delete this entire session (video, metadata, and annotations)?")) return;
        try {
          // If the session video is local (file://), use metadataUrl to identify S3 keys for deletion
          const deleteUrl = (session.videoUrl && session.videoUrl.startsWith('file://')) ? session.metadataUrl : session.videoUrl;
          if (!deleteUrl) {
            alert('Cannot determine S3 keys for deletion');
            return;
          }

          await client.deleteSession(deleteUrl);
          sessionDiv.remove();
          console.log(`✅ Deleted session ${deleteUrl}`);
        } catch (err) {
          console.error("Failed to delete session:", err);
          alert("Error deleting session.");
        }
      };
      heading.appendChild(deleteSessionBtn);

      let video = null;
      if (session.videoUrl) {
        video = document.createElement('video');
        video.controls = true;
        // session.videoUrl can be a signed http URL or a file:// URL
        video.src = session.videoUrl;
      } else {
        const noVideo = document.createElement('div');
        noVideo.style.padding = '12px';
        noVideo.style.background = 'rgba(255,255,255,0.04)';
        noVideo.style.border = '1px dashed rgba(255,0,255,0.15)';
        noVideo.style.maxWidth = '700px';
        noVideo.style.marginBottom = '1em';
        noVideo.textContent = 'No video file available on S3 or locally.';
        sessionDiv.appendChild(noVideo);
      }

      const annotationDiv = document.createElement('div');
      annotationDiv.innerHTML = `<em>Loading annotations...</em>`; 

      fetch(session.annotationUrl)
        .then(res => res.json())
        .then(annotations => {
          annotationDiv.innerHTML = '';
          const videoStart = session.videoStartTimestamp;

          annotations.forEach(a => {
            const offset = (a.timestamp - videoStart) / 1000;
            const minutes = Math.floor(offset / 60);
            const seconds = Math.floor(offset % 60);
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const note = document.createElement('div');
            note.className = 'annotation';
            note.innerHTML = `<strong>${timeStr}</strong>: ${a.note}`;
            note.onclick = () => {
              if (video) {
                video.currentTime = offset;
                video.play();
              } else {
                alert('No video available for this session.');
              }
            }; 

            // Back to Home button logic
            const backBtn = document.getElementById('back-home');
            backBtn.addEventListener('mouseenter', () => {
              backBtn.style.background = "rgba(255,0,255,0.2)";
              backBtn.style.color = "#00ffff";
              backBtn.style.textShadow = "0 0 8px #00ffff, 0 0 16px #00ffff";
            });
            backBtn.addEventListener('mouseleave', () => {
              backBtn.style.background = "rgba(40,0,60,0.6)";
              backBtn.style.color = "#ff00ff";
              backBtn.style.textShadow = "0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff";
            });
            backBtn.addEventListener('click', () => {
              ipcRenderer.send('open-home');
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '✕';
            deleteBtn.onclick = async (e) => {
              e.stopPropagation();
              try {
                await client.deleteAnnotation(session.annotationUrl, a.timestamp);
                note.remove();
              } catch (err) {
                console.error("Failed to delete annotation:", err);
                alert(`Error deleting annotation: ${err}`);
              }
            };
            note.appendChild(deleteBtn);
            annotationDiv.appendChild(note);
          });
        })
        .catch(err => {
          annotationDiv.innerHTML = `<strong>No annotations detected</strong>`;
          console.error('Error fetching annotations:', err);
        });

      sessionDiv.appendChild(heading);
      sessionDiv.appendChild(video);
      sessionDiv.appendChild(annotationDiv);
      sessionContainer.appendChild(sessionDiv);
    }

  </script>
</body>

</html>
</html>
