<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Note Annotation</title>
  <!-- Link to external stylesheet -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="annotation-ui">
    <textarea id="note" placeholder="Type your annotation or press Escape to exit..."></textarea>
    <button class = "button-small" onclick="saveNote()">Save</button>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    /**
     * Abandon the note and hide the overlay.
     */
    function hideOverlay() {
      document.getElementById('note').value = '';
      ipcRenderer.send('hide-overlay');
    }

    function saveNote() {
      const note = document.getElementById('note').value;
      if (!note.trim()) return; // optional: ignore empty notes
      const timestamp = Date.now();
      ipcRenderer.send('save-annotation', { note, timestamp });
      hideOverlay();
    }

    // Trigger saveNote() on Enter key
    const noteInput = document.getElementById('note');
    noteInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // prevent adding a new line
        saveNote();
      }
    });

    document.addEventListener('keydown', event => {
      // If the user presses "Escape" and the note is empty, she probably wants
      // to close the annotation overlay because she opened it on accident.
      if (event.key == 'Escape') {
        const note = document.getElementById('note').value;
        if (!note.trim()) {
          hideOverlay();
          event.preventDefault();
        }
      }
    })

    ipcRenderer.on('emoji-reaction', (event, emoji) => {
      const annotationUI = document.getElementById('annotation-ui');
      if (annotationUI) annotationUI.style.display = 'none';
      showEmojiReaction(emoji);
    });

    ipcRenderer.on('show-annotation-ui', () => {
      const annotationUI = document.getElementById('annotation-ui');
      if (annotationUI) annotationUI.style.display = 'flex';
      noteInput.focus();
    });

    ipcRenderer.on('emoji-reaction', (event, emoji) => {
      ipcRenderer.send('show-emoji', emoji);
    });
  </script>
</body>
</html>
